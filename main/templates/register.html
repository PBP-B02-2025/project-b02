{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register | Ballistic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
</head>
<body class="bg-[#f9fafb] w-full min-h-screen flex items-center justify-center p-8">

    <div class="max-w-md w-full">
        <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">

            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Join us</h1>
                <p class="text-gray-600 text-sm">Create your Ballistic account!</p>
            </div>

            <!-- Non-field errors -->
            {% if form.non_field_errors %}
            <div class="mb-6">
                {% for error in form.non_field_errors %}
                <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700">
                    {{ error }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Field errors -->
            {% if form.errors %}
            <div class="mb-6">
                {% for field, errors in form.errors.items %}
                    {% if field != '__all__' %}
                        {% for error in errors %}
                        <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                            <strong>{{ field|title }}:</strong> {{ error }}
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Form -->
            <form id="registerForm" class="space-y-6">
                {% csrf_token %}
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input id="username" name="username" type="text" required placeholder="Choose a username"
                        class="w-full border-gray-300 rounded-md focus:outline-none placeholder-gray-400 transition">
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input id="email" name="email" type="email" required placeholder="your.email@example.com"
                        class="w-full border-gray-300 rounded-md focus:outline-none placeholder-gray-400 transition">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                        <input id="first_name" name="first_name" type="text" required placeholder="John"
                            class="w-full border-gray-300 rounded-md focus:outline-none placeholder-gray-400 transition">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                        <input id="last_name" name="last_name" type="text" required placeholder="Doe"
                            class="w-full border-gray-300 rounded-md focus:outline-none placeholder-gray-400 transition">
                    </div>
                </div>

                <div>
                    <label for="password1" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input id="password1" name="password1" type="password" required placeholder="Create a password"
                        class="w-full border-gray-300 rounded-md focus:outline-none placeholder-gray-400 transition">
                </div>

                <div>
                    <label for="password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                    <input id="password2" name="password2" type="password" required placeholder="Confirm your password"
                        class="w-full border-gray-300 rounded-md focus:outline-none placeholder-gray-400 transition">
                </div>

                <button type="submit"
                    class="w-full px-4 py-3 bg-black rounded-md hover:bg-[#333] transition-colors text-white font-medium">
                    Create Account
                </button>
            </form>

            <!-- Django Messages -->
            {% if messages %}
            <div class="mt-6">
                {% for message in messages %}
                <div class="
                    px-4 py-3 rounded text-sm border
                    {% if message.tags == 'success' %}
                        bg-green-50 border-green-200 text-green-700
                    {% elif message.tags == 'error' %}
                        bg-red-50 border-red-200 text-red-700
                    {% else %}
                        bg-gray-50 border-gray-200 text-gray-700
                    {% endif %}
                ">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Footer -->
            <div class="mt-6 text-center pt-2">
                <p class="text-gray-500 text-sm">
                    Already have an account?
                    <a href="{% url 'main:login' %}" class="text-black hover:text-[#333] transition-colors font-medium">
                        Sign In
                    </a>
                </p>
            </div>
            
        </div>
    </div>
    {% include 'toast.html' %}
    <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const registerForm = document.getElementById('registerForm');

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(registerForm);
        document.querySelectorAll('.error-text').forEach(el => el.remove());
        document.querySelectorAll('.form-error-global').forEach(el => el.remove());
        try {
            const response = await fetch("{% url 'main:register_ajax' %}", {
                method: "POST",
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken,
                },
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('Success', 'Account created successfully!', 'success');
                registerForm.reset();
                setTimeout(() => {
                    window.location.href = "{% url 'main:login' %}";
                }, 500);
            } else {
                const errorMessage = 'Failed to register';
                showToast('Error', errorMessage, 'error');
                if (data.errors) {
                    for (const [field, messages] of Object.entries(data.errors)) {
                        const input = registerForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            const errorDiv = document.createElement('p');
                            errorDiv.className = 'error-text text-sm text-red-600 mt-1';
                            errorDiv.textContent = messages.join(', ');
                            input.insertAdjacentElement('afterend', errorDiv);
                        }
                    }
                } else {
                    const formContainer = registerForm.closest('.form-style');
                    const generalError = document.createElement('div');
                    generalError.className = 'form-error-global px-4 py-3 mb-4 rounded-md text-sm border bg-red-50 border-red-200 text-red-700';
                    generalError.textContent = data.error || 'Registration failed.';
                    formContainer.insertAdjacentElement('afterbegin', generalError);
                }
            }
        } catch (err) {
            console.error(err);
            showToast('Server Error', 'Please try again later.', 'error');
        }
    });
</script>


</body>
</html>
