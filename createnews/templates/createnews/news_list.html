{% extends 'base.html' %}
{% block title %}News - Ballistic{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Latest News</h2>
    {% if request.user.is_authenticated and request.user.is_staff %}
      <button class="btn btn-success rounded-circle" id="openCreateBtn" style="width:45px; height:45px;">ï¼‹</button>
    {% endif %}
  </div>

  <div class="row">
    <!-- MAIN CONTENT -->
    <div class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <label class="fw-semibold me-2">Sort by category:</label>
        <select id="categoryFilter" class="form-select" style="max-width: 220px;">
          <option value="">All</option>
          {% for code, label in categories %}
            <option value="{{ code }}" {% if request.GET.category == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div id="news-grid" class="row">
        {% for news in news_list %}
        <div class="col-md-4 mb-4" id="news-{{ news.id }}">
          <div class="card h-100 shadow-sm border-0">
            {% if news.thumbnail %}
              <img src="{{ news.thumbnail }}" class="card-img-top" style="height:200px; object-fit:cover;">
            {% endif %}
            <div class="card-body">
              {% if news.is_featured %}
                <span class="badge bg-warning text-dark mb-2">Populer</span>
              {% endif %}
              <h5 class="card-title fw-semibold">{{ news.title }}</h5>
              <p class="small text-muted mb-1">Oleh: {{ news.author }}</p>
              <p class="text-truncate" style="max-height:60px;">{{ news.content }}</p>
            </div>
            <div class="card-footer bg-white border-0 d-flex justify-content-between">
              <a href="{% url 'createnews:show_news_detail' news.id %}" class="btn btn-outline-primary btn-sm">Detail</a>
              {% if request.user.is_authenticated and request.user.is_staff %}
                <div>
                  <button class="btn btn-sm btn-secondary me-1" onclick="openEditModal('{{ news.id }}')">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteNews('{{ news.id }}')">Delete</button>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">Belum ada berita.</p>
        {% endfor %}
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="col-lg-3">
      <h5 class="fw-bold mb-3">Populer</h5>
      <ul class="list-group list-group-flush">
        {% for p in popular_list %}
        <li class="list-group-item px-0 border-0 mb-2">
          <a href="{% url 'createnews:show_news_detail' p.id %}" class="text-decoration-none text-dark">
            <div class="d-flex align-items-center">
              {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="me-2 rounded" width="50" height="50" style="object-fit:cover;">
              {% endif %}
              <div>
                <small class="fw-semibold">{{ p.title }}</small><br>
                <small class="text-muted">{{ p.author }}</small>
              </div>
            </div>
          </a>
        </li>
        {% empty %}
        <p class="text-muted">Belum ada berita populer.</p>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="create-form" class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Create News</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="title" class="form-control mb-3" placeholder="Title" required>
        <input name="author" class="form-control mb-3" placeholder="Author" required>
        <textarea name="content" class="form-control mb-3" placeholder="Content" rows="4" required></textarea>
        <select name="category" class="form-select mb-3">
          {% for code,label in categories %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input name="thumbnail" class="form-control mb-3" placeholder="Thumbnail URL">
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" name="is_featured" id="create_featured">
          <label for="create_featured" class="form-check-label">Populer</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Publish</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="edit-form" class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Edit News</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id" name="id">
        <input name="title" id="edit-title" class="form-control mb-3" placeholder="Title" required>
        <input name="author" id="edit-author" class="form-control mb-3" placeholder="Author" required>
        <textarea name="content" id="edit-content" class="form-control mb-3" placeholder="Content" rows="4" required></textarea>
        <select name="category" id="edit-category" class="form-select mb-3">
          {% for code,label in categories %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input name="thumbnail" id="edit-thumbnail" class="form-control mb-3" placeholder="Thumbnail URL">
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" id="edit-featured" name="is_featured">
          <label for="edit-featured" class="form-check-label">Populer</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const csrftoken = document.cookie.split('=')[1];
const createModal = new bootstrap.Modal(document.getElementById('createModal'));
const editModal = new bootstrap.Modal(document.getElementById('editModal'));

document.getElementById('openCreateBtn')?.addEventListener('click', () => createModal.show());

document.getElementById('create-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const res = await fetch("{% url 'createnews:create_news_ajax' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    body: new FormData(e.target)
  });
  if (res.ok) {
    createModal.hide();
    location.reload();
  } else alert('Gagal menambah berita (hanya admin).');
});

function openEditModal(id) {
  const card = document.getElementById('news-' + id);
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-title').value = card.querySelector('.card-title').textContent.trim();
  document.getElementById('edit-author').value = card.querySelector('.text-muted').textContent.replace('Oleh: ', '').trim();
  document.getElementById('edit-content').value = card.querySelector('.text-truncate').textContent.trim();
  document.getElementById('edit-thumbnail').value = card.querySelector('img')?.src || '';
  document.getElementById('edit-featured').checked = !!card.querySelector('.badge');
  editModal.show();
}

document.getElementById('edit-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('edit-id').value;
  const res = await fetch(`/news/edit/${id}/`, {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    body: new FormData(e.target)
  });
  if (res.ok) {
    editModal.hide();
    location.reload();
  } else alert('Gagal mengedit berita.');
});

async function deleteNews(id) {
  if (!confirm('Yakin ingin menghapus berita ini?')) return;
  const res = await fetch(`/news/delete/${id}/`, {method:'POST', headers:{'X-CSRFToken': csrftoken}});
  if (res.ok) document.getElementById('news-' + id).remove();
  else alert('Gagal menghapus berita.');
}

document.getElementById('categoryFilter').addEventListener('change', (e) => {
  const value = e.target.value;
  const url = new URL(window.location.href);
  if (value) url.searchParams.set('category', value);
  else url.searchParams.delete('category');
  window.location.href = url.toString();
});
</script>
{% endblock %}
