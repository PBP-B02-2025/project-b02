{% extends 'createnews/base.html' %}
{% block title %}News - Ballistic{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="container py-5">
  <h2 class="fw-bold ballistic-title text-center">BALLISTIC NEWS</h2>
    {% if request.user.is_authenticated and request.user.is_staff %}
    <div class="d-flex justify-content-end mb-4">
    <button class="btn-create rounded-circle" id="openCreateBtn">＋</button>
</div>
    {% endif %}
  </div>

  <div class="row">
    <!-- main konten -->
    <div class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <label class="fw-semibold me-2">Sort by category:</label>
        <select id="categoryFilter" class="form-select" style="max-width: 220px;">
          <option value="">All</option>
          {% for code, label in categories %}
            <option value="{{ code }}" {% if request.GET.category == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div id="news-grid" class="row">
        {% for news in news_list %}
        <div class="col-md-4 mb-4" id="news-{{ news.id }}">
          <div class="card h-100 shadow-sm border-0">
            {% if news.thumbnail %}
              <img src="{{ news.thumbnail }}" class="card-img-top" style="height:200px; object-fit:cover;">
            {% endif %}
            <div class="card-body">
              {% if news.is_featured %}
                <span class="badge bg-warning text-dark mb-2">Populer</span>
              {% endif %}
              <h5 class="card-title fw-semibold">{{ news.title }}</h5>
              <p class="small text-muted mb-1">Dibuat oleh: {{ news.author }}</p>
              <p class="text-truncate" style="max-height:60px;">{{ news.content }}</p>
            </div>
            <div class="card-footer bg-white border-0 d-flex justify-content-between">
              <a href="{% url 'createnews:show_news_detail' news.id %}" class="btn btn-outline-dark btn-sm">Detail</a>

              {% if request.user.is_authenticated and request.user.is_staff %}
                <div>
                  <button class="btn btn-sm btn-secondary me-1" onclick="openEditModal('{{ news.id }}')">Edit</button>
                  <button class="btn btn-sm btn-danger delete-btn" data-id="{{ news.id }}">Delete</button>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">Belum ada berita.</p>
        {% endfor %}
      </div>
    </div>

    <!-- sidebar -->
    <div class="col-lg-3">
      <h5 class="fw-bold mb-3">Populer</h5>
      <ul class="list-group list-group-flush">
        {% for p in popular_list %}
        <li class="list-group-item px-0 border-0 mb-2">
          <a href="{% url 'createnews:show_news_detail' p.id %}" 
          class="text-decoration-none text-dark">
          <div class="d-flex align-items-center">
              {% if p.thumbnail %}
                <img src="{{ p.thumbnail }}" class="me-2 rounded" width="50" height="50" style="object-fit:cover;">
              {% endif %}
              <div>
                <small class="fw-semibold">{{ p.title }}</small><br>
                <small class="text-muted">{{ p.author }}</small>
              </div>
            </div>
          </a>
        </li>
        {% empty %}
        <p class="text-muted">Belum ada berita populer.</p>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<!-- create modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="create-form" class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Create News</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="title" class="form-control mb-3" placeholder="Title" required>
        <input name="author" class="form-control mb-3" placeholder="Author" required>
        <textarea name="content" class="form-control mb-3" placeholder="Content" rows="4" required></textarea>
        <select name="category" class="form-select mb-3">
          {% for code,label in categories %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input name="thumbnail" class="form-control mb-3" placeholder="Thumbnail URL">
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" name="is_featured" id="create_featured">
          <label for="create_featured" class="form-check-label">Populer</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Publish</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="edit-form" class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">Edit News</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id" name="id">
        <input name="title" id="edit-title" class="form-control mb-3" placeholder="Title" required>
        <input name="author" id="edit-author" class="form-control mb-3" placeholder="Author" required>
        <textarea name="content" id="edit-content" class="form-control mb-3" placeholder="Content" rows="4" required></textarea>
        <select name="category" id="edit-category" class="form-select mb-3">
          {% for code,label in categories %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input name="thumbnail" id="edit-thumbnail" class="form-control mb-3" placeholder="Thumbnail URL">
        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" id="edit-featured" name="is_featured">
          <label for="edit-featured" class="form-check-label">Populer</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function showToast(type, message) {
  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 2000,
    timerProgressBar: true,
    background: "#fff",
    color: "#333",
  });
  Toast.fire({ icon: type, title: message });
}

const csrftoken = document.cookie.split('=')[1];
const createModal = new bootstrap.Modal(document.getElementById('createModal'));
const editModal = new bootstrap.Modal(document.getElementById('editModal'));

// buka modal create
document.getElementById('openCreateBtn')?.addEventListener('click', () => createModal.show());

// create news (tanpa reload)
document.getElementById('create-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  const res = await fetch("{% url 'createnews:create_news_ajax' %}", {
    method: 'POST',
    credentials: 'same-origin', // penting biar session admin ikut
    headers: {'X-CSRFToken': csrftoken},
    body: formData,
  });

  if (res.status === 403) {
    showToast("error", "Hanya admin yang bisa menambah berita!");
    return;
  }

  const data = await res.json();

if (res.ok && data.title) {
  // menambahkan berita baru langsung ke tampilan
  const cardHTML = `
      <div class="col-md-4 mb-4" id="news-${data.id}">
        <div class="card h-100 shadow-sm border-0">
          ${data.thumbnail ? `<img src="${data.thumbnail}" class="card-img-top" style="height:200px; object-fit:cover;">` : ""}
          <div class="card-body">
            ${data.is_featured ? '<span class="badge bg-warning text-dark mb-2">Populer</span>' : ''}
            <h5 class="card-title fw-semibold">${data.title}</h5>
            <p class="small text-muted mb-1">Dibuat oleh: ${data.author}</p>
            <p class="text-truncate" style="max-height:60px;">${data.content}</p>
          </div>
          <div class="card-footer bg-white border-0 d-flex justify-content-between">
            <a href="/news/detail/${data.id}/" class="btn btn-outline-dark btn-sm">Detail</a>
            <div>
              <button class="btn btn-sm btn-secondary me-1" onclick="openEditModal('${data.id}')">Edit</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="${data.id}">Delete</button>
            </div>
          </div>
        </div>
      </div>`;
  
  document.getElementById("news-grid").insertAdjacentHTML("afterbegin", cardHTML);

  // menambahkan baris ini supaya sidebar populer ikut diperbarui:
  if (data.is_featured) {
    await updatePopularList();
  }

  showToast("success", "Berita berhasil ditambahkan 🎉");
  form.reset();
  createModal.hide();
  } else {
    showToast("error", "Gagal menambah berita!");
  }
});

// edit news
document.getElementById('edit-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('edit-id').value;

  try {
    const res = await fetch(`/news/edit/${id}/`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'X-CSRFToken': csrftoken },
      body: new FormData(e.target)
    });

    if (!res.ok) {
      if (res.status === 403) {
        showToast("error", "⚠️ Hanya admin yang bisa mengedit berita!");
      } else if (res.status === 404) {
        showToast("error", "❌ URL edit tidak ditemukan!");
      } else {
        showToast("error", `Gagal menyimpan perubahan (Error ${res.status})`);
      }
      return;
    }

    const data = await res.json();

    // jika berhasil, update DOM langsung tanpa reload
    if (data && data.title) {
      const card = document.getElementById(`news-${id}`);
      if (card) {
        // update gambar (kalau ada)
        const img = card.querySelector("img");
        if (img && data.thumbnail) img.src = data.thumbnail;

        // update judul, author, dan konten
        card.querySelector(".card-title").textContent = data.title;
        card.querySelector(".text-muted").textContent = "Dibuat oleh: " + data.author;

        const desc = card.querySelector(".text-truncate");
        desc.innerHTML = data.content || "(tanpa konten)";
        desc.style.display = "block"; // pastikan muncul lagi kalau sempat hilang

        // update badge Populer
        const badge = card.querySelector(".badge");
        if (data.is_featured) {
          if (!badge) {
            card.querySelector(".card-body").insertAdjacentHTML(
              "afterbegin",
              '<span class="badge bg-warning text-dark mb-2">Populer</span>'
            );
          }
        } else if (badge) {
          badge.remove();
        }
      }

      // update sidebar Populer juga (tanpa reload)
      updatePopularList();

      showToast("success", "✅ Berita berhasil diperbarui!");
      editModal.hide();
    } else {
      showToast("error", "⚠️ Tidak ada data berita yang diterima dari server!");
    }

  } catch (err) {
    console.error("Edit error:", err);
    showToast("error", "Terjadi kesalahan koneksi dengan server!");
  }
});

//  Fungsi untuk memperbarui sidebar populer tanpa reload
async function updatePopularList() {
  try {
    const res = await fetch("{% url 'createnews:show_news_list' %}?ajax=1");
    if (!res.ok) return;
    const data = await res.json();

    const sidebar = document.querySelector(".list-group-flush");
    sidebar.innerHTML = ""; // kosongkan dulu

    data.popular_list.forEach(p => {
      const itemHTML = `
        <li class="list-group-item px-0 border-0 mb-2">
          <a href="/news/detail/${p.id}/" class="text-decoration-none text-dark">
            <div class="d-flex align-items-center">
              ${p.thumbnail ? `<img src="${p.thumbnail}" class="me-2 rounded" width="50" height="50" style="object-fit:cover;">` : ""}
              <div>
                <small class="fw-semibold">${p.title}</small><br>
                <small class="text-muted">${p.author}</small>
              </div>
            </div>
          </a>
        </li>`;
      sidebar.insertAdjacentHTML("beforeend", itemHTML);
    });
  } catch (err) {
    console.error("Gagal memperbarui sidebar populer:", err);
  }
}


// event Delegation untuk tombol Delete (termasuk yang baru ditambahkan)
document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("delete-btn")) return;

  const id = e.target.dataset.id;
  if (!confirm("Yakin ingin menghapus berita ini?")) return;

  try {
const res = await fetch(`/news/delete/${id}/`, {
  method: "POST", // <-- bukan delete kalau view-nya pakai POST
  headers: { "X-CSRFToken": csrftoken },
});

    if (res.ok) {
      // hapus card dari tampilan
      const card = document.getElementById(`news-${id}`);
      if (card) card.remove();

      // melakukan update sidebar populer langsung tanpa reload
      updatePopularList();

      showToast("success", "🗑️ Berita berhasil dihapus!");
    } else {
      showToast("error", "Gagal menghapus berita!");
    }
  } catch (err) {
    console.error("Delete error:", err);
    showToast("error", "Terjadi kesalahan koneksi saat menghapus berita!");
  }
});


document.getElementById('categoryFilter').addEventListener('change', (e) => {
  const value = e.target.value;
  const url = new URL(window.location.href);
  if (value) url.searchParams.set('category', value);
  else url.searchParams.delete('category');
  window.location.href = url.toString();
});
function openEditModal(id) {
  try {
    const card = document.getElementById('news-' + id);
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-title').value = card.querySelector('.card-title').textContent.trim();
    document.getElementById('edit-author').value = card.querySelector('.card-body .text-muted').textContent.replace('Dibuat oleh: ', '').trim();
    document.getElementById('edit-content').value = card.querySelector('.text-truncate').textContent.trim();
    document.getElementById('edit-thumbnail').value = card.querySelector('img')?.src || '';
    document.getElementById('edit-featured').checked = !!card.querySelector('.badge');
    editModal.show();
  } catch (err) {
    console.error("Gagal membuka modal edit:", err);
    Swal.fire("Error", "Gagal membuka modal edit berita.", "error");
  }
}

</script>
{% endblock %}